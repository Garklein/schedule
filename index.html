<title>UOttawa Course Schedule</title>
<body>
	<textarea id="i"></textarea>
	<button id="go">go (then, enter to return)</button>
	<table id="table"></table>
</body>

<style>
table, th, td { border: 1px solid; border-collapse: collapse; padding: 10px; text-align: center; margin: 30px; }
</style>

<script>
const timeToMilitary = s => {
	const [h, m] = s.split(":"), hour = +h, min = (+m[0] >> 1) / 2, ampm = m.match(/PM/) && hour !== 12 ? 12 : 0;
	return hour + min + ampm }

const militaryToTime = t => {
	const hour = ~~(t < 13 ? t : t-12), min = (t%1 * 60 + "").padStart(2, "0"); return `${hour}:${min}` }

const parse = s => {
	s = s.split("\n").filter(l => l.trim())
	let colours = ["LightSkyBlue", "Tomato", "Wheat", "Gold", "LightGreen", "Thistle", "AliceBlue", "Orange"]
	const next = _ => s.shift(),
	      skip = n => s.splice(0, n);
	const useColour = _ => colours.splice(~~(Math.random() * colours.length), 1)[0];
	const parseWhile = (cond, parse, after = _ => {}) => { const a = []; while (cond()) a.push(parse()), after(); return a }

	const nextIsTime = _ => s[0] && s[0].match(/^(Mo|Tu|We|Th|Fr)/),
	      day        = d => ["Mo", "Tu", "We", "Th", "Fr"].indexOf(d.slice(0, 2)),
	      time       = d => d.slice(2).split(" - ").map(timeToMilitary),
	      parseTime  = _ => { const l = next(); return { day: day(l), time: time(l) } }

	const parseLocation = _ => next().split("(")[1].replace(")", ""),
	  		parseMeeting  = _ => ({ ...parseTime(), location: parseLocation() }),
				parseSection  = _ => { skip(3); return parseWhile(nextIsTime, parseMeeting, _ => skip(2)) },
				parseSections = _ => parseWhile(_ => !isNaN(s[0]), parseSection).flat(),
				skipHeader    = _ => { while (!next().match(/^Class Nbr/)); },
				parseName     = _ => { const name = next().split(" - ")[1]; skipHeader(); return name },
				parseClass		= _ => ({ name: parseName(), meetings: parseSections(), colour: useColour() })

	const sortDay = day => day.toSorted((d1, d2) => d1.time[0] - d2.time[0])
	const parsed   = parseWhile(_ => s.length, parseClass),
				meetings = parsed.map(({ name, colour, meetings }) => meetings.map(m => ({ ...m, name, colour }))).flat(),
				days     = Object.values(Object.groupBy(meetings, m => m.day)).map(sortDay)
	return days }

const c           = elt => document.createElement(elt)
const headerElts  = ["Time", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
const headerNodes = headerElts.map(h => { const elt = c("th"); elt.textContent = h; return elt })
const header      = c("thead"); header.insertRow(), headerNodes.forEach(h => header.rows[0].appendChild(h))

var start, end, t;
const startEnd = days => { const ts = days.flat().map(m => m.time).flat(); start = Math.min(...ts), end = Math.max(...ts) }

const addTimes   = _ => { for (let i = start; i < end; i += 1/2) t.insertRow().insertCell().textContent = militaryToTime(i) }
const addBlock   = (s, e) => { if (e <= s) return; const cell = t.rows[(s-start)*2].insertCell();
	cell.rowSpan   = (e-s)*2; return cell; }
const addSpare   = (s, e) => { const spare = addBlock(s, e); if (spare) spare.style.border = "0px" }
const addMeeting = ({ time, name, location, colour }) => { const meeting = addBlock(...time);
	meeting.innerHTML = `${name}<br>${location}`; meeting.style.backgroundColor = colour }
const handleMeeting = (i, m) => m.time[0] < i ? i : (addSpare(i, m.time[0]), addMeeting(m), m.time[1])
const addDay     = (day) => addSpare(day.reduce(handleMeeting, start), end)

const makeTable = days => { table.appendChild(header); t = c("tbody"); table.appendChild(t);
	startEnd(days); addTimes(); days.forEach(d => addDay(d)); }

go.onclick       = _ => { i.hidden = go.hidden = true; makeTable(parse(i.value)) }
window.onkeydown = e => { if (e.key !== "Enter") return; i.hidden = go.hidden = false; i.value = table.innerHTML = "" }
</script>
