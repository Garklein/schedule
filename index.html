<title>UOttawa Course Schedule</title>
<body>
	<textarea id="i"></textarea>
	<button id="go">go (then, enter to return)</button>
	<table id="table"></table>
</body>

<style>
table, th, td { border: 1px solid; border-collapse: collapse; padding: 10px; text-align: center; margin: 30px; }
</style>

<script>
const timeToMilitary = s => {
	const [h, m] = s.split(":"), hour = +h, min = (+m[0] >> 1) / 2, ampm = m.match(/PM/) && hour !== 12 ? 12 : 0;
	return hour + min + ampm }

const militaryToTime = t => {
	const hour = ~~(t < 13 ? t : t-12), min = (t%1 * 60 + "").padStart(2, "0"); return `${hour}:${min}` }

const parse = s => {
	s = s.split("\n").filter(l => l.trim())
	const next = _ => s.shift(),
	      skip = n => s.splice(0, n)
	let colours = ["LightSkyBlue", "Tomato", "Wheat", "Gold", "LightGreen", "Thistle", "AliceBlue", "Orange"]
	const useColour = _ => colours.splice(~~(Math.random() * colours.length), 1)[0]
	const parseWhile = (cond, parse, after = _ => {}) => { const a = []; while (cond()) a.push(parse()), after(); return a }

	const nextIsTime = _ => s[0] && s[0].match(/^(Mo|Tu|We|Th|Fr)/),
	      day        = d => ["Mo", "Tu", "We", "Th", "Fr"].indexOf(d.slice(0, 2)),
	      time       = d => d.slice(2).split(" - ").map(timeToMilitary),
	      parseTime  = _ => { const l = next(); return { day: day(l), time: time(l) } }

	const parseLocation = _ => next().split("(")[1].replace(")", ""),
	  		parseEvent    = _ => ({ ...parseTime(), location: parseLocation() }),
				parseSection  = _ => { skip(3); return parseWhile(nextIsTime, parseEvent, _ => skip(2)) },
				skipHeader    = _ => { while (!next().match(/^Class Nbr/)); },
				parseBody     = _ => (skipHeader(), parseWhile(_ => !isNaN(s[0]), parseSection).flat()),
				parseName     = _ => next().split(" - ")[1],
				parseClass		= _ => ({ name: parseName(), events: parseBody(), colour: useColour() })

	const sortDay = day => day.toSorted((d1, d2) => d1.time[0] - d2.time[0])
	const parsed   = parseWhile(_ => s.length, parseClass),
				events = parsed.map(({ name, colour, events }) => events.map(e => ({ ...e, name, colour }))).flat()
	return Object.values(Object.groupBy(events, e => e.day)).map(sortDay) }

const makeTable = days => {
	const c = (elt, par, cb = _ => {}) => { elt = document.createElement(elt); par.appendChild(elt); cb(elt); return elt }

	const makeHeader = h => {
		const titles = ["Time", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
		h.insertRow(); titles.map(t => c("th", h.rows[0], elt => elt.textContent = t)) }

	const makeBody = b => {
		const times = days.flat().map(m => m.time).flat(), start = Math.min(...times), end = Math.max(...times);
		const addChunk = (s, e, cb) => s < e && c("td", b.rows[(s-start)*2], cell => (cell.rowSpan = (e-s)*2, cb(cell))),
		      addSpare = (s, e)     => addChunk(s, e, c => c.style.border = "0px")
		const styleEvent  = e => c => (c.innerHTML = `${e.name}<br>${e.location}`, c.style.backgroundColor = e.colour),
		      addEvent    = e => addChunk(e.time[0], e.time[1], styleEvent(e)),
		      handleEvent = (t, e) => e.time[0] < t ? t : (addSpare(t, e.time[0]), addEvent(e), e.time[1])
		const addDay = d => { const lastClass = d.reduce(handleEvent, start); addSpare(lastClass, end) }
		for (let t = start; t < end; t += 1/2) b.insertRow().insertCell().textContent = militaryToTime(t); days.forEach(addDay) }

	c("thead", table, makeHeader); c("tbody", table, makeBody); }

go.onclick       = _ => { i.hidden = go.hidden = true; makeTable(parse(i.value)) }
window.onkeydown = e => { if (e.key !== "Enter") return; i.hidden = go.hidden = false; i.value = table.innerHTML = "" }
</script>
